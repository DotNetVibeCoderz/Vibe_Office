@page "/reports"
@using PersonalFinanceApp.Data
@using PersonalFinanceApp.Services
@inject ReportService ReportService
@inject TransactionService TransactionService

<MudContainer>
    <MudText Typo="Typo.h5" Class="mb-4">Financial Reports</MudText>
    
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-4">Expenses by Category</MudText>
                @if (PieData.Any())
                {
                    <MudChart ChartType="ChartType.Pie" InputData="@PieData" InputLabels="@PieLabels" Width="300px" Height="300px" />
                }
                else
                {
                    <MudText>No expense data this month.</MudText>
                }
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-4">Cash Flow (Last 6 Months)</MudText>
                 <MudChart ChartType="ChartType.Line" ChartSeries="@Series" XAxisLabels="@XAxisLabels" Width="100%" Height="350px" ChartOptions="@Options"></MudChart>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    public double[] PieData { get; set; } = new double[] { };
    public string[] PieLabels { get; set; } = new string[] { };

    public List<ChartSeries> Series { get; set; } = new List<ChartSeries>();
    public string[] XAxisLabels { get; set; } = new string[] { };
    public ChartOptions Options = new ChartOptions();

    protected override async Task OnInitializedAsync()
    {
        var now = DateTime.Now;
        var categories = await TransactionService.GetCategoriesAsync();
        var transactions = await TransactionService.GetAllAsync(); 
        
        // 1. Pie Chart: Expenses this month
        var thisMonthExpenses = transactions
            .Where(t => t.Type == TransactionType.Expense && t.Date.Month == now.Month && t.Date.Year == now.Year)
            .GroupBy(t => t.CategoryId)
            .Select(g => new { CategoryId = g.Key, Amount = g.Sum(t => t.Amount) })
            .ToList();

        if (thisMonthExpenses.Any())
        {
            PieData = thisMonthExpenses.Select(x => (double)x.Amount).ToArray();
            PieLabels = thisMonthExpenses.Select(x => 
                categories.FirstOrDefault(c => c.Id == x.CategoryId)?.Name ?? "Unknown").ToArray();
        }

        // 2. Line Chart: Income vs Expense last 6 months (Mock Logic + Real Data potential)
        // For simplicity, let's generate 6 months labels
        var months = new List<string>();
        var incomeData = new List<double>();
        var expenseData = new List<double>();

        for (int i = 5; i >= 0; i--)
        {
            var d = now.AddMonths(-i);
            months.Add(d.ToString("MMM"));
            
            // Mock random data variation + existing data if any
            // Since we don't have much data, we'll use some dummy base + actuals
            var income = (double)await ReportService.GetTotalIncomeAsync(d.Month, d.Year);
            var expense = (double)await ReportService.GetTotalExpenseAsync(d.Month, d.Year);
            
            // If data is 0 (empty db), add some mock for visual demo
            if (income == 0 && expense == 0)
            {
                income = 5000 + (new Random().Next(-500, 500));
                expense = 3000 + (new Random().Next(-500, 500));
            }

            incomeData.Add(income);
            expenseData.Add(expense);
        }

        XAxisLabels = months.ToArray();

        Series = new List<ChartSeries>()
        {
            new ChartSeries() { Name = "Income", Data = incomeData.ToArray() },
            new ChartSeries() { Name = "Expense", Data = expenseData.ToArray() },
        };

        Options.YAxisFormat = "C0";
    }
}